name: Auto-Link Branch to Issue

on:
  #create:
    - push

jobs:
  link-issue:
    runs-on: ubuntu-latest
    if: github.ref_type == 'branch'
    permissions:
      contents: read
      issues: write
    steps:
      - name: Extract WI Number from Branch Name
        id: extract
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          echo "Branch name: $BRANCH_NAME"
          
          # Extract WI number from branch name (e.g., feature/WI-123-Add-login -> 123)
          if [[ $BRANCH_NAME =~ ^([^/]+)/([A-Za-z]+)-([0-9]+)-(.+)$ ]]; then
            WI_NUMBER="${BASH_REMATCH[3]}"
            echo "wi_number=$WI_NUMBER" >> $GITHUB_OUTPUT
            echo "Found WI number: $WI_NUMBER"
          else
            echo "Branch name does not match expected format (type/WI-#-Title)"
            echo "wi_number=" >> $GITHUB_OUTPUT
          fi

      - name: Search for Corresponding Issue
        id: search_issue
        if: steps.extract.outputs.wi_number != ''
        run: |
          WI_NUMBER="${{ steps.extract.outputs.wi_number }}"
          
          # Check if an issue with this number exists
          ISSUE_EXISTS=$(gh issue view $WI_NUMBER \
            --repo "${{ github.repository }}" \
            --json number \
            --jq '.number // empty' 2>/dev/null)
          
          if [ -z "$ISSUE_EXISTS" ]; then
            echo "No issue found with number #$WI_NUMBER"
            echo "issue_number=" >> $GITHUB_OUTPUT
          else
            echo "Found issue #$WI_NUMBER"
            echo "issue_number=$WI_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if Branch Already Linked
        id: check_link
        if: steps.search_issue.outputs.issue_number != ''
        run: |
          ISSUE_NUMBER="${{ steps.search_issue.outputs.issue_number }}"
          BRANCH_NAME="${{ github.ref_name }}"
          
          # Check if the branch is already linked by looking for it in linked branches
          LINKED=$(gh issue view $ISSUE_NUMBER \
            --repo "${{ github.repository }}" \
            --json linkedBranches \
            --jq '.linkedBranches[].name | select(. == "'$BRANCH_NAME'") // empty')
          
          if [ -n "$LINKED" ]; then
            echo "Branch already linked to issue #$ISSUE_NUMBER"
            echo "already_linked=true" >> $GITHUB_OUTPUT
          else
            echo "Branch not yet linked"
            echo "already_linked=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Link Branch to Issue
        if: steps.check_link.outputs.already_linked == 'false'
        run: |
          ISSUE_NUMBER="${{ steps.search_issue.outputs.issue_number }}"
          BRANCH_NAME="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          
          # Use GraphQL to link the branch to the issue
          gh api graphql -f owner='${REPO%/*}' -f repo='${REPO##*/}' -f issue_number="$ISSUE_NUMBER" -f branch_name="$BRANCH_NAME" -f query='
            query($owner: String!, $repo: String!, $issue_number: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $issue_number) {
                  id
                }
              }
            }
            
            mutation($issue_id: ID!, $branch_name: String!) {
              linkRepositoryToPullRequest(input: {repositoryId: $issue_id, pullRequestId: $branch_name}) {
                clientMutationId
              }
            }
          ' 2>/dev/null || true
          
          # Fallback: Create a comment that mentions the branch (GitHub will auto-link it)
          gh issue comment $ISSUE_NUMBER \
            --repo "$REPO" \
            --body "Branch: $BRANCH_NAME"
          
          echo "âœ“ Successfully linked branch $BRANCH_NAME to issue #$ISSUE_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}