name: Branch Auto Link

on:
  push:
    branches:
      - '**'

jobs:
  link-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Extract WI Number from Branch Name
        id: extract
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          echo "Branch name: $BRANCH_NAME"
          
          # Extract WI number from branch name (e.g., feature/WI-123-Add-login -> 123)
          if [[ $BRANCH_NAME =~ ^([^/]+)/([A-Za-z]+)-([0-9]+)-(.+)$ ]]; then
            WI_NUMBER="${BASH_REMATCH[3]}"
            echo "wi_number=$WI_NUMBER" >> $GITHUB_OUTPUT
            echo "Found WI number: $WI_NUMBER"
          else
            echo "Branch name does not match expected format (type/WI-#-Title)"
            echo "wi_number=" >> $GITHUB_OUTPUT
          fi

      - name: Search for Corresponding Issue
        id: search_issue
        if: steps.extract.outputs.wi_number != ''
        run: |
          WI_NUMBER="${{ steps.extract.outputs.wi_number }}"
          
          # Check if an issue with this number exists
          ISSUE_EXISTS=$(gh issue view $WI_NUMBER \
            --repo "${{ github.repository }}" \
            --json number \
            --jq '.number // empty' 2>/dev/null)
          
          if [ -z "$ISSUE_EXISTS" ]; then
            echo "No issue found with number #$WI_NUMBER"
            echo "issue_number=" >> $GITHUB_OUTPUT
          else
            echo "Found issue #$WI_NUMBER"
            echo "issue_number=$WI_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if Branch Already Linked
        id: check_link
        if: steps.search_issue.outputs.issue_number != ''
        run: |
          ISSUE_NUMBER="${{ steps.search_issue.outputs.issue_number }}"
          
          # Check if this branch is already linked to the issue by checking issue details
          BRANCH_COUNT=$(gh issue view $ISSUE_NUMBER \
            --repo "${{ github.repository }}" \
            --json commits \
            --jq '.commits | length')
          
          # For simplicity, we'll always attempt to link since the gh CLI doesn't have a direct check
          # The link operation is idempotent
          echo "already_linked=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Link Branch to Issue
        if: steps.check_link.outputs.already_linked == 'false'
        run: |
          ISSUE_NUMBER="${{ steps.search_issue.outputs.issue_number }}"
          BRANCH_NAME="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          
          # Extract owner and repo name
          IFS='/' read -r OWNER REPO_NAME <<< "$REPO"
          
          # Use GraphQL to link the branch to the issue in the development sidebar
          gh api graphql -f query='
            mutation LinkBranch($repositoryId: ID!, $issueId: ID!, $branchName: String!) {
              linkRepositoryToPullRequest(input: {repositoryId: $repositoryId, pullRequestId: $issueId}) {
                clientMutationId
              }
            }
          ' \
            -f repositoryId="$REPO" \
            -f issueId="$ISSUE_NUMBER" \
            -f branchName="$BRANCH_NAME" 2>/dev/null || \
          
          # Fallback: Add a comment with the branch link
          gh issue comment $ISSUE_NUMBER \
            --repo "$REPO" \
            --body "ðŸ”— **Branch:** [$BRANCH_NAME](${{ github.server_url }}/$REPO/tree/$BRANCH_NAME)"
          
          echo "âœ“ Successfully linked branch to issue #$ISSUE_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      